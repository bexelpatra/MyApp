<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Visit Location on Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Stylish&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<script>
    let map;
    let locationInterval;
    let initFg = "Y";
    let bottom = "hidden";

    window.onload = function() {
                document.querySelector('.bottom-list-container').classList.toggle(bottom);
                readFile();
            }

    function readFile(){
         //let returnData = '[{"lat":"37.123","lon":"127.123","memo":"없음","time":"2024-11-08  13:31:16"},{"lat":"37.125","lon":"127.125","memo":"","time":"2024-11-08  13:35:10"}]';
        initMap();

        let returnData = Android.readFile(now(1), 1);
        //console.log("##### tab returnData : ", returnData);
        let locInfo = JSON.parse(returnData);

        if(locInfo != ""){
            createLiTag(locInfo);
        }
        currentLocation();
        initFg = "N";
    }

    function initMap(locInfo){
        if(initFg == 'Y'){
            let currentLocation = JSON.parse(Android.getCurrentLocation());

            // 지도 초기화
            map = L.map('map').setView([currentLocation.lat, currentLocation.lon], 18);

            // OpenStreetMap 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

        }else{
            if(locInfo != null){
                if (navigator.geolocation) {
                    let i = 1;
                    locInfo.forEach(location => {

                        let popup = '방문 장소 ' + i + ' ( ' + location.time + ' )'
                            + '<br>위도 : ' + location.lat + ' / 경도 : ' + location.lon
                            + '<br>메모 : ' + location.memo;

                        L.marker([location.lat, location.lon]).addTo(map).bindPopup(popup).openPopup();
                        map.setView([location.lat, location.lon], 18);
                    });
                } else {
                    alert('Your browser does not support Geolocation.');
                }
            }
        }
    }

    function currentLocation(){
        let currentLocation = JSON.parse(Android.getCurrentLocation());

        let popup = '현재 위치 ' + ' ( ' + now(3) + ' )'
            + '<br>위도 : ' + currentLocation.lat + ' / 경도 : ' + currentLocation.lon

        L.marker([currentLocation.lat, currentLocation.lon]).addTo(map).bindPopup(popup).openPopup();
        map.setView([currentLocation.lat, currentLocation.lon], 18);
    }

    async function save(lat, lon, autoFg){
        let memo;

        if(!autoFg){
            memo = document.getElementById('memo').value
        }

        newInfo = {};
        newInfo.time = now(3);
        newInfo.lat = lat??"";
        newInfo.lon = lon??"";
        newInfo.memo = memo;

        let saveData = {};
        saveData.data = newInfo;
        saveData.type = autoFg == true ? 0 : 1;
        //console.log("####### save Data : " , JSON.stringify(saveData));

        let saveReturnData = Android.save(JSON.stringify(saveData));
        //console.log("####### saveReturn Data : " , saveReturnData);

        let returnData = Android.readFile(now(1), 1);
        //let returnData = '[{"lat":"37.123","lon":"127.123","memo":"없음","time":"2024-11-08  13:31:16"},{"lat":"37.125","lon":"127.125","memo":"","time":"2024-11-08  13:35:10"},{"lat":"37.122","lon":"127.124","memo":"123","time":"2024-11-08  13:38:42"},{"lat":"37.121","lon":"127.121","memo":"ㅂㅈㄷ","time":"2024-11-08  13:42:05"}]';
        //console.log("####### Return Data : " , returnData);

        let locInfo = JSON.parse(returnData);
        //console.log("####### locInfo Data : " , locInfo);

        createLiTag(locInfo);

        if(!autoFg){
            //document.getElementById('currntLocationSaveDiv').style.display = 'none';
            reset();
        }
    }

    function createLiTag(locInfo){
        let visitList = document.getElementById("visitList");
        while (visitList.firstChild) {
            visitList.removeChild(list.firstChild);
        }

        for(let i=0; i<locInfo.length; i++){
            let visit = '방문 장소 ' + (i + 1) + ' ( ' + locInfo[i].time + ' )'
                        + '<br>위도 : ' + locInfo[i].lat + ' / 경도 : ' + locInfo[i].lon
                        + '<br>메모 : ' + locInfo[i].memo;

            let li = document.createElement('li');
            li.innerHTML = visit;
            li.onclick = function() {
                L.marker([locInfo[i].lat, locInfo[i].lon]).addTo(map)
                    .bindPopup(visit)
                    .openPopup();

                map.setView([locInfo[i].lat, locInfo[i].lon], map.getZoom()); // 지도의 중앙을 마커 위치로 설정
            };
            visitList.appendChild(li);

        }

        listToggle("show");
    }

    function listToggle(param){
        if(param != bottom){
            let listContainer = document.querySelector('.bottom-list-container');
            listContainer.classList.toggle(param);
            bottom = param;
        }
    }

    function autoMap(){
        //if(initFg == 'Y'){
            // 지도 초기화
            map = L.map('autoMap').setView([0, 0], 2);

            // OpenStreetMap 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        //}

        // 현재 위치 가져오기 및 지도에 표시
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;
                let marker = L.marker([lat, lon]).addTo(map)
                    .bindPopup('위도 : ' + lat + ' / 경도 : ' + lon)
                    .openPopup();
                map.setView([lat, lon], 18);
            }, (error) => {
                alert('Geolocation service failed. : ' + error.message);
            });
        } else {
            alert('Your browser does not support Geolocation.');
        }
    }

    function reset() {
        document.getElementById('memo').value = "";
    }

    function autoOn(param){
        locationInterval = setInterval(updateLocation, 2000);
        alert("자동 저장 시작");
    }

    function updateLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                let lat = position.coords.latitude;
                let lon = position.coords.longitude;
                document.getElementById("currentLoction").innerHTML = '현재위치 : ' + lat + ' / ' + lon;
                save(lat, lon, true);
            }, (error) => {
                alert('Geolocation service failed. : ' + error.message);
            });

        } else {
            document.getElementById("location").innerHTML = "이 브라우저는 Geolocation을 지원하지 않습니다.";
        }
    }

    function autoOff(param){
        clearInterval(locationInterval);
        alert("자동 저장 종료");
    }

    function now(param){
        /*
            param : return
            1 : 년월일
            2 : 시분초
            3 : 년월일  시분초
        */
        let today = new Date();

        let year = today.getFullYear();
        let month = ('0' + (today.getMonth() + 1)).slice(-2);
        let day = ('0' + today.getDate()).slice(-2);
        let hours = ('0' + today.getHours()).slice(-2);
        let minutes = ('0' + today.getMinutes()).slice(-2);
        let seconds = ('0' + today.getSeconds()).slice(-2);

        let dateString;
        if(param == 1) dateString = year + '-' + month  + '-' + day;
        if(param == 2) dateString = hours + ':' + minutes  + ':' + seconds;
        if(param == 3) dateString = year + '-' + month  + '-' + day + '  ' + hours + ':' + minutes  + ':' + seconds;

        return dateString;
    }

    // Action Sheet 보이기
    function showActionSheet() {
        document.getElementById("actionSheet").classList.add("active");
        readFile();
    }

    // Action Sheet 감추기
        function hideActionSheet() {
        document.getElementById("actionSheet").classList.remove("active");
    }

</script>
<body>
    <div id="currntLocationSaveDiv">
        <p>
            메모 :
            <!--<input type="text" class="text-input" id="memo" name="메모">-->
            <textarea id="memo" name="메모" placeholder=""></textarea>
        </p>
        <p>
            <button class="button" id="mapBt" onClick='save()'>저장</button>
            <button class="button" id="currntBt" onClick='currentLocation()'>현재위치</button>
        </p>
    </div>
    <div id="loc_div"></div>
    <div id="map"></div>
    <div class="bottom-list-container" id="bottomListContainer">
        <div class="hamburger" id="handle">
            <span></span>
        </div>
        <ul class="bottom-list" id="visitList"></ul>
    </div>
</div>
<script>
    let handle = document.getElementById('handle');
    let container = document.getElementById('bottomListContainer');
    let list = document.getElementById('visitList');

    handle.addEventListener('mouseup', function(e) {
        list.style.display = 'block'; // 목록을 보이게 합니다.
        container.classList.toggle('full-height');
    });
</script>
</body>
</html>
